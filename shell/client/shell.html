<!--
Sandstorm - Personal Cloud Sandbox
Copyright (c) 2014 Sandstorm Development Group, Inc. and contributors
All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<head>
  <title>Sandstorm</title>
  <script type="text/javascript" src="/logo.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
</body>

<template name="layout">
  {{>sandstormTopbar globalTopbar}}

  {{!-- standard topbar items --}}
  {{#sandstormTopbarItem name="homelink" topbar=globalTopbar}}
    <a href="/" id="homelink" class="navlink">Sandstorm</a>
  {{/sandstormTopbarItem}}
  {{>sandstormTopbarItem name="account" topbar=globalTopbar data=globalAccountsUi
                         template="loginButtons" popupTemplate="loginButtonsPopup"}}
  {{#if currentUser}}
    {{>sandstormTopbarItem name="notifications" topbar=globalTopbar
                           template="notifications" popupTemplate="notificationsPopup"}}
  {{/if}}
  {{#with adminAlert}}
    {{#if adminAlertIsTooLarge}}
      {{#sandstormTopbarItem name="admin-alert" topbar=globalTopbar}}
        {{!-- TODO(cleaup): Awkwardly, the event handlers on Template.layout actually work
            on this topbar item solely because the whole topbar itself is embedded inside the
            "layout" template. But, we shouldn't be relying on that! Move this to its own
            template... --}}
        <span id="admin-alert-icon" class="{{className}}">!</span>
      {{else}}
        <h4>Notice from Admin</h4>
        <p>
          {{#if alertUrl}}
            <a href="{{alertUrl}}" class="alert {{className}}">{{text}}</a>
          {{else}}
            <span class="alert {{className}}">{{text}}</span>
          {{/if}}
        </p>
      {{/sandstormTopbarItem}}
    {{else}}
      {{#sandstormTopbarItem name="admin-alert" topbar=globalTopbar}}
        {{#if alertUrl}}
          <a href="{{alertUrl}}" class="alert {{className}}">{{text}}</a>
        {{else}}
          <span class="alert {{className}}">{{text}}</span>
        {{/if}}
      {{/sandstormTopbarItem}}
    {{/if}}
  {{/with}}

  {{> yield}}
</template>

<template name="lightLayout">
  {{>sandstormTopbar globalTopbar}}

  {{> yield}}
</template>

<template name="notifications">
  {{#if notificationCount}}
    <span class="count">{{notificationCount}}</span>
  {{/if}}
  Notifications
</template>

<template name="notificationsPopup">
  <h4>Notifications</h4>
  <ul id="notification-list">
    {{#each notifications}}
      <li>
        <div class="notification-item">
          <div class="notification-header">
              <span>{{grainTitle}}</span>
              <span title="Stops the background app" class="cancel-notification" data-notificationid="{{_id}}">Cancel</span>
              <span title="{{timestamp}}" class="notification-timestamp">{{dateString timestamp}}</span>
          </div>
          <span>{{text.defaultText}}</span>
        </div>
      </li>
    {{else}}
    <li>No Notifications...</li>
    {{/each}}
  </ul>
</template>

<template name="title">
  {{#sandstormTopbarItem name="title" priority=5 topbar=globalTopbar}}{{.}}{{/sandstormTopbarItem}}
</template>

<template name="loading">
  {{>title "Loading..."}}
  <div class="main-content">
    <div class="centered-box">Loading...</div>
  </div>
</template>

<template name="notFound">
  {{>title "Not Found"}}
  <div class="main-content">
    <div class="centered-box">404 Not Found :(</div>
  </div>
</template>

<template name="root">
  {{>title "Home"}}

  {{#if isAdmin}}
    {{#sandstormTopbarItem name="admin" topbar=globalTopbar}}
      <a href="/admin" class="navlink">Admin Settings</a>
    {{/sandstormTopbarItem}}
  {{/if}}
  {{#sandstormTopbarItem name="about" topbar=globalTopbar}}
    <a href="/about" class="navlink">About</a>
  {{/sandstormTopbarItem}}

  <div id="intro" class="main-content">
    {{#if kernelTooOld}}
      <div class="action-required">
        <h1>Action Required</h1>
        <p>This server is not currently receiving updates because the server's Linux kernel version
          is too old, or because it is not configured correctly. The next update of Sandstorm will
          require Linux kernel 3.13 or better and will require that the sysctl
          <code>kernel.unprivileged_userns_clone</code> (if it exists on your system) is set to 1
          (enabled). This will allow Sandstorm to run completely without root privileges using new
          Linux kernel features, thus making you safer. If you are the server admin and you are
          unsure what to do, re-run the Sandstorm installer.</p>
        <p><button class=".dismiss-action-required">Dismiss</button></p>
      </div>
    {{/if}}

    {{#if hideSplashScreen}}

      <div id="applist-closer" data-show="{{showMenu}}"></div>
      <div id="applist-apps" data-show="{{showMenu}}">
        <ul>
         {{#if isSignedUpOrDemo}}
           <li class="applist-tab-my-files {{#if selectedTab.myFiles}}selected{{/if}}">My Files</li>
         {{/if}}
         <li class="applist-tab-shared-with-me {{#if selectedTab.sharedWithMe}}selected{{/if}}">
            Shared With Me</li>
          {{#each apps}}
            <li class="applist-tab {{appTabClass appId}} {{#if isDev}}dev{{/if}}"
                data-appid="{{appId}}">{{name}}</li>
          {{/each}}
          <li class="blank">&nbsp;</li>
          {{#if isAdmin}}
            <li class="applist-tab-settings">Admin Settings</li>
          {{/if}}
          <li class="applist-tab-about">About Sandstorm</li>
        </ul>
      </div>
      <div id="applist-grains" class="{{#if selectedAppIsDev}}dev{{/if}}">
        {{#if selectedTab.appId}}
          <div class="button-box">
            <button class="show-apps">« My Apps</button>
            {{#each devActions}}
              <button class="new-grain-button" data-actionid="dev"
                  data-devid="{{_id}}" data-index="{{index}}">{{title}}</button>
            {{else}}
              {{#each actions}}
                <button class="new-grain-button {{#if overQuota}}over-quota{{/if}}"
                    data-actionid="{{_id}}">{{title}}</button>
              {{/each}}
              <button class="uninstall-app-button" data-appid="{{selectedTab.appId}}">
                Uninstall</button>
            {{/each}}
            <span>
              {{#if selectedAppMarketingVersion}}
                v{{selectedAppMarketingVersion}}
              {{/if}}
            </span>
          </div>
        {{else}}
          {{#if selectedTab.myFiles}}
            <div class="button-box">
              <button class="show-apps">« My Apps</button>
              <button id="install-apps-button" class="{{#if overQuota}}over-quota{{/if}}">
                  Install apps</button>
              <button id="upload-app-button" class="{{#if overQuota}}over-quota{{/if}}">
                  Upload an app</button>
              <button id="restore-backup-button" class="{{#if overQuota}}over-quota{{/if}}">
                  Restore a backup</button>
            </div>
          {{else}}
            <div class="button-box">
              <button class="show-apps">« My Apps</button>
            </div>
          {{/if}}
        {{/if}}

        {{#unless selectedTab.sharedWithMe}}
          {{#if quotaEnabled}}
            <div id="storage-usage" class="{{#if overQuota}}over-quota{{/if}}">{{storageUsage}}
              {{#with storageQuota}}
                of {{.}}
              {{/with}}
              used
            </div>
          {{/if}}
        {{/unless}}

        {{#if filteredGrains}}
          <table>
            <thead>
              <tr>
                <td>Title</td>
                <td>Last Used</td>
              </tr>
            </thead>
            <tbody>
              {{#each filteredGrains}}
                <tr class="grain" data-grainid="{{_id}}">
                  <td>{{title}}</td>
                  <td title="{{lastUsed}}">{{dateString lastUsed}}</td>
                </tr>
              {{/each}}
            </tbody>
          </table>

          {{#if isDemoUser}}
            <aside>
              <form id="signup" action="https://sandstorm.us7.list-manage.com/subscribe/post?u=1a036c5ea0fc3c215793748ed&amp;id=5d9399a0af" method="post">
                <p>Join our mailing list for updates<br>
                <input type="email" name="EMAIL" placeholder="e-mail" required><input type="submit" value="&#10003;"></p>
              </form>
              <a id="preorder" href="https://sandstorm.io/preorder.html">
                <span>Early Bird</span>
                <span>Pre-order Now</span>
              </a>
              <div id="social">
                <ul>
                  <li id="github"><a href="https://github.com/sandstorm-io/sandstorm">Github</a></li>
                  <li id="feed"><a href="https://blog.sandstorm.io/feed.xml">Atom/RSS feed</a></li>
                  <li id="twitter"><a href="https://twitter.com/SandstormIO">Twitter</a></li>
                  <li id="google-plus"><a href="https://google.com/+SandstormIo">Google+</a></li>
                  <li id="facebook"><a href="https://facebook.com/sandstorm.io">Facebook</a></li>
                </ul>
                <p>Connect with us</p>
              </div>
            </aside>
          {{/if}}
        {{else}}
          {{#unless selectedTab.sharedWithMe}}
            <div id="install-arrow"></div>
          {{/unless}}
        {{/if}}
      </div>

    {{else}}

      <div id="logo">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
        </svg>
        <script type="text/javascript">setTimeout(initLogoAnimation, 0);</script>
      </div>
      <h1>Sandstorm</h1>
        <p class="build-tag">Build {{build}}</p>

      {{#if isFirstRun}}
        <p>
          This Sandstorm instance has no users. You should generate a token from the command line
          with `sandstorm admin-token` in order to access the admin settings page.
        </p>
      {{else}}
        {{#if allowDemoAccounts}}
          <p><a href="/demo">Try the demo!</a></p>
        {{else}}
        <p>
          {{{splashDialog}}}
        </p>
        {{/if}}
      {{/if}}
    {{/if}}
  </div>
</template>

<template name="grainTitle">
  <span class="editable" title="Rename" id="grainTitle">{{title}}</span>
</template>
<template name="grainDeleteButton">
  <button class="grain-button" title="Delete" id="deleteGrain">Delete</button>
</template>
<template name="grainDebugLogButton">
  <button class="grain-button" title="Show Debug Log" id="openDebugLog">Log</button>
</template>
<template name="grainBackupButton">
  <button class="grain-button" title="Download Backup" id="backupGrain">Backup</button>
</template>
<template name="grainRestartButton">
  <button class="grain-button" title="Restart App" id="restartGrain">Restart</button>
</template>

<template name="grainApiTokenButton">
  Get&nbsp;Webkey
</template>

<template name="grainApiTokenPopup">
  <h4>Webkeys</h4>
  {{#if apiToken}}
    {{#if apiTokenPending}}
      <p>Generating...</p>
      <p><button id="resetApiToken">Cancel</button></p>
    {{else}}
      <p>Copy this webkey and give it to the external app:</p>
        <a id="apiTokenText" class="copy-me" href="{{apiToken}}">{{apiToken}}</a>
      {{#if currentUser}}
        <p><button id="resetApiToken">Go back</button></p>
      {{/if}}
    {{/if}}
  {{else}}
    <p>A webkey allows you to connect an external app (e.g. a mobile app) to this app.</p>
    <p><form id="newApiToken">
    Label: <input type="text" id="api-token-petname" placeholder="e.g. 'Android app'">
    {{#with viewInfo}}
      {{#if roles}}
        Role:
        <select id="api-token-role">
          <option title="has every app permission" selected=true>all access</option>
          {{#each roles}}
            <option title={{verbPhrase.defaultText}}
                    style="{{#if obsolete}}display:none{{else}}{{/if}}">
              {{title.defaultText}}</option>
          {{/each}}
        </select>
      {{/if}}
    {{/with}}
    <button>Create</button></form></p>
    {{#if existingTokens}}
      <p>Your existing webkeys:</p>
      <ul>
      {{#each existingTokens}}
        {{#if displayToken}}
          <li>
            <span class="token-petname" data-token-id="{{_id}}">
              {{petname}} ({{dateString created}})
            </span>
            <button class="revoke-token" title="revoke" data-token-id="{{_id}}">revoke</button>
          </li>
        {{/if}}
      {{/each}}
      </ul>
    {{/if}}
  {{/if}}
</template>

<template name="grainShareButton">
  Share
</template>

<template name="grainSharePopup">
  <h4>Share with others...</h4>
  {{#if oldSharingModel}}
    <p>This grain uses the old sharing model. You can share it by copy/pasting the URL from the
        location bar.</p>
    {{#if isOwner}}
    <p>You can upgrade this grain to the new model, but anyone with whom you shared this grain
      previously will lose access; you will have to share it with them again. If you have
      generated webkeys for external apps, you might also need to regenerate those.</p>
    <p>Upgrading cannot be undone.</p>
    <p><button id="privatize-grain">upgrade</button></p>
    {{/if}}
  {{else}}
    {{#if shareToken}}
      {{#if shareTokenPending}}
        <p>Generating...</p>
        <p><button id="reset-share-token">Cancel</button></p>
      {{else}}
        <p>Copy this link and share it with other users to grant access:</p>
        <a id="share-token-text" class="copy-me" href="{{shareToken}}">{{shareToken}}</a>
        <p><button id="reset-share-token">Go back</button></p>
      {{/if}}
    {{else}}
      {{#if transitiveShares}}
        {{#if transitiveShares.empty}}
          <p></p>
          <p> You have granted access to nobody. </p>
        {{else}}
          <p>Users who have received access through you:</p>
          <ul>
            {{#each transitiveShares}}
              <li>
                <div>{{displayName recipient}} was granted access by:</div>
                <ul>
                  {{#each shares}}
                    <li>{{displayName userId}} ({{dateString created}})</li>
                  {{/each}}
                </ul>
              </li>
            {{/each}}
          </ul>
        {{/if}}
        <button class="hide-transitive-shares">back</button>
      {{else}}
        <p>Create a secret link to share with other users.</p>
        <p><form id="new-share-token">
        Label: <input onclick="select()" type="text"
                id="share-token-petname" value="unlabeled sharing link">
        {{#with viewInfo}}
          {{#if roles}}
            Role:
            <select id="share-token-role" title="select a role">
              {{#each roles}}
                <option title={{verbPhrase.defaultText}}
                        style="{{#if obsolete}}display:none{{/if}}"
                        selected={{default}}>
                  {{title.defaultText}}</option>
              {{/each}}
            </select>
          {{/if}}
        {{/with}}
        <button>Create</button>
        </form></p>
        {{#if existingShareTokens}}
          <p> Your existing links: </p>
          <ul>
          {{#each existingShareTokens}}
            {{#if displayToken}}
              <li>
                <span class="token-petname" data-token-id="{{_id}}">
                  {{petname}} ({{dateString created}})
                </span>
                <button class="revoke-token" title="revoke" data-token-id="{{_id}}">revoke</button>
              </li>
            {{/if}}
          {{/each}}
          </ul>
        {{else}}
          <p>You have not created any links.</p>
        {{/if}}
        <button class="show-transitive-shares">see who has access</button>
      {{/if}}
    {{/if}}
  {{/if}}
</template>

<template name="grainPowerboxRequest">
  P
</template>
<template name="grainPowerboxRequestPopup">
  <h4>Powerbox Request</h4>
  <div>
    <form id="powerbox-request-form">
      <label>Please input an api token: </label><input name="token" type="text" id="powerbox-request-input"><br>
      <button class="submit">Import token</button>
    </form>
    {{#if error.get}}
    <div class="error">{{error.get}}</div>
    {{/if}}
  </div>
</template>

<template name="grainPowerboxOffer">
  P
</template>
<template name="grainPowerboxOfferPopup">
  <h4>Powerbox Offer</h4>
  <div>
    <a class="copy-me" href="{{powerboxOfferUrl}}" id="powerbox-offer-url">{{powerboxOfferUrl}}</a>
    <button class="dismiss">Dismiss</button>
  </div>
</template>

<template name="grain">
  {{>sandstormTopbarItem name="title" priority=5 topbar=globalTopbar template="grainTitle"}}
  {{#sandstormTopbarItem name="grain-size" topbar=globalTopbar}}
    {{grainSize}}
  {{/sandstormTopbarItem}}

  {{>sandstormTopbarBlockReload}}

  {{setGrainWindowTitle}}

  {{#if currentUser}}
    {{>sandstormTopbarItem name="share" topbar=globalTopbar
          template="grainShareButton" popupTemplate="grainSharePopup"}}
    {{>sandstormTopbarItem name="delete" topbar=globalTopbar template="grainDeleteButton"}}
  {{/if}}
  {{#if isOwner}}
    {{>sandstormTopbarItem name="debug-log" topbar=globalTopbar template="grainDebugLogButton"}}
    {{>sandstormTopbarItem name="backup" topbar=globalTopbar template="grainBackupButton"}}
    {{>sandstormTopbarItem name="restart" topbar=globalTopbar template="grainRestartButton"}}
  {{/if}}
  {{#if displayWebkeyButton}}
    {{>sandstormTopbarItem name="webkey" topbar=globalTopbar
        template="grainApiTokenButton" popupTemplate="grainApiTokenPopup"}}
  {{/if}}
  {{#if showPowerboxRequest}}
    {{>sandstormTopbarItem name="request" topbar=globalTopbar template="grainPowerboxRequest"
        startOpen=true popupTemplate="grainPowerboxRequestPopup"}}
  {{/if}}
  {{#if showPowerboxOffer}}
    {{>sandstormTopbarItem name="offer" topbar=globalTopbar template="grainPowerboxOffer"
        startOpen=true popupTemplate="grainPowerboxOfferPopup"}}
  {{/if}}

  <div id="app" class="main-content">
    {{#if error}}
      <pre>{{error}}</pre>
    {{else}}
    {{#if appOrigin}}
      <iframe id="grain-frame" src="{{appOrigin}}/_sandstorm-init?sessionid={{sessionId}}&path={{path}}{{hash}}"></iframe>
      {{#if hasNotLoaded}}
        {{> _grainSpinner}}
      {{/if}}
    {{else}}
    {{#if interstitial}}
      <div class="interstitial-button-box">
        <p>This grain was shared by someone who is not in your contacts.</p>
        <button id="redeem-token-button" data-token="{{token}}">Reveal your Identity</button>
        <button id="incognito-button" data-token="{{token}}">Open in Incognito Mode</button>
      </div>
    {{else}}
      {{> _grainSpinner}}
    {{/if}}
    {{/if}}
    {{/if}}
  </div>
</template>

<template name="_grainSpinner">
  <!-- This is a terrible hack to center this thing. The styles shold go in css, but it's
    arguably more confusing to put them there when all they're doing is this archaic pattern to
    get a horizontally+vertically centered div -->
  <div id="grain-loading-spinner">
    <div style="display:table-cell;vertical-align:middle;">
      <div style="margin-left:auto;margin-right:auto;text-align:center;">
        <img src="/spinner_96.gif" alt="loading">
      </div>
    </div>
  </div>
</template>

<template name="grainLog">
  {{#sandstormTopbarItem name="title" priority=5 topbar=globalTopbar}}
    Debug log: {{title}}
  {{/sandstormTopbarItem}}

  <div id="grainLog" class="main-content">
    <pre>...{{{html}}}</pre>
  </div>
</template>

<template name="install">
  {{>title "Install app"}}

  {{#if error}}
    <div id="install" class="main-content error">
      <div class="centered-box">
        <p>Failed to install app!
          {{#if step}}<button id="retry">Try Again</button>{{/if}}</p>
        <pre>{{error}}</pre>
      </div>
    </div>
  {{else}}
    <div id="install" class="main-content instep-{{step}}">
      {{! TODO(cleanup):  The use of a list here is vestigial.  We now display only the step
            that is currently running. }}
      <ol>
        <li id="step-wait">Waiting for write access...</li>
        <li id="step-download">Downloading... <span class="progress">{{progress}}
            <button id="cancelDownload">Cancel</button></span></li>
        <li id="step-verify">Verifying... <span class="progress">{{progress}}</span></li>
        <li id="step-unpack">Unpacking... <span class="progress">{{progress}}</span></li>
        <li id="step-analyze">Analyzing... <span class="progress">{{progress}}</span></li>
        <li id="step-confirm">Install this app?
          <div class="confirm-form">
            {{! TODO(someday):  Support editing action names (i.e. make them petnames). }}
            {{#if hasOlderVersion}}
              <p>You have an older version of this app installed.  Do you want to upgrade?</p>
              <p><button id="confirmInstall">Upgrade</button></p>
            {{else}}
            {{#if hasNewerVersion}}
              <p>You already have a newer version of this app installed.  Are
                you sure you want to revert to this older version?</p>
              <p><button id="confirmInstall">Downgrade</button></p>
            {{else}}
              <p>Do you want to install this app?</p>
              <p><button id="confirmInstall">Install</button></p>
            {{/if}}
            {{/if}}
          </div></li>
        <li id="step-run">App Installed
          <div class="done-notice">
            <p>Installation complete.  Click "My Files" to create a new file with this app.</p>

            {{#if hasNewerVersion}}
              <p>Some of your files were made with a
                <a href="{{newVersionId}}">newer version</a> of this app.  They will keep
                using the newer version, as going backwards could break them.</p>
            {{else}}
            {{#if hasOlderVersion}}
              <p>Some of your files were made with an older version of this app.  Upgrade them?</p>
              <p><button id="upgradeGrains">Upgrade Files</button></p>
            {{else}}
              <div id="my-files-arrow"></div>
            {{/if}}
            {{/if}}
          </div></li>
        <li id="step-delete">Server is currently deleting this app...</li>
      </ol>
    </div>
  {{/if}}
</template>

<template name="signup">
  {{>title "Claim Invite"}}

  <div id="signup" class="main-content">
  <div class="centered-box">
  {{#if alreadySignedUp}}
    <p>You're all signed up!  Now go <a href="https://sandstorm.io/apps/?host={{origin}}">install
      some apps</a>.</p>
  {{else}}
    {{#if keyIsValid}}
      {{#if keyIsUsed}}
        <p>Sorry, this signup key has already been used.</p>
      {{else}}
        {{#if currentUser}}
          <p>Please wait...</p>
        {{else}}
          <p>{{signupDialog}} First, you have to sign in. Click "Sign in" in the upper-right.</p>
          <div id="sign-in-arrow"></div>
        {{/if}}
      {{/if}}
    {{else}}
      <p>Sorry, this is not a valid signup key.</p>
    {{/if}}
  {{/if}}
  </div>
  </div>
</template>

<template name="adminInvites">
  <div id="invite">
    {{#if error}}
      <p>{{error}}</p>
      <p><button id="retry">Try Again</button></p>
    {{else}}{{#if url}}
      <p>New key: <input type="text" class="autoSelect" value="{{url}}" readonly></p>
      <p>Send this key to someone to allow them to create an account on your server.</p>
      <p><button id="retry">Create Another</button></p>
    {{else}}{{#if sent}}
      <p>Sent!</p>
      <p><button id="retry">Send more</button></p>
    {{else}}
      <p>You can invite friends to create accounts on your server. People you invite will be
        able to install apps and create files of their own. You do NOT need to invite someone
        if you just want to share your files with them.</p>
      <h3>Create a link:</h3>
      <p>This will create a magic link which you can send to someone.</p>
      <p>
        {{#if quotaEnabled}}
          Quota: <input id="key-quota" type="text" placeholder="(bytes; blank for none)"><br>
        {{/if}}
        <input id="key-note" type="text" placeholder="notes, e.g. name of the recipient">
        <button id="create">Create</button></p>

      <h3>Send an e-mail:</h3>
      <p>This will create a link and send it in an e-mail. <code>$KEY</code> will be replaced
        with the newly-generated link.</p>
      <div style="text-align: right; margin-top: 1em;">
        <p>From: <input type="text" id="invite-from" placeholder="me@example.com" value="{{email}}"></p>
        <p>To:
        <textarea id="invite-emails" placeholder="E-mail addresses, one per line."></textarea></p>
        <p>Subject: <input type="text" id="invite-subject" value="Join my Sandstorm server!"></p>
        <p>Body:
        <textarea id="invite-message">Click on the following link to get access to my Sandstorm.io server.

  $KEY</textarea></p>
        {{#if quotaEnabled}}
          <p>Quota: <input id="invite-quota" type="text" placeholder="(bytes; blank for none)"></p>
        {{/if}}
        <p><button id="send">Send</button></p>
      </div>

      {{#if quotaEnabled}}
        <h3>Update quotas:</h3>
        <p>You can batch modify existing users' quotas by specifying the e-mail address under which they were invited. This only works for user who were invited using the "Send an e-mail" form, above.</p>
        <div style="text-align: right; margin-top: 1em;">
          <p>Emails:
          <textarea id="set-quota-emails" placeholder="E-mail addresses, one per line."></textarea></p>
          <p>Quota: <input id="set-quota-quota" type="text" placeholder="(bytes; blank for none)"></p>
          <p><button id="set-quota-submit">Update</button></p>
        </div>
      {{/if}}
    {{/if}}
    {{/if}}
    {{/if}}
  </div>
</template>

<template name="adminLog">
  <div id="adminLog">
    <pre>...{{{html}}}</pre>
  </div>
</template>

<template name="uploadForm">
  {{>title "Upload App"}}

  <div id="upload" class="main-content">
    <div class="centered-box">
    {{#if isSignedUp}}
      {{#if progress}}
        <p>Uploading... {{progress}}%</p>
      {{else}}
        {{#if error}}
          <p>Upload failed: {{error.status}} {{error.statusText}}</p>
        {{else}}
          <p>Please choose an <code>spk</code> file to install.</p>
        {{/if}}
        <p><input type="file" id="uploadFile">
           <button id="uploadButton">Upload</button></p>
      {{/if}}
    {{else}}
      {{#if isDemoUser}}
        <p>Sorry, demo users are not allowed to upload new apps, but you can
          <a href="https://sandstorm.io/apps/?host={{origin}}">install apps from sandstorm.io</a>.</p>
      {{else}}
        <p>Sorry, Sandstorm is in closed alpha.  To install apps, you must first be invited.</p>
      {{/if}}
    {{/if}}
    </div>
  </div>
</template>

<template name="restoreGrainStatus">
  {{>title "Restoring Grain..."}}

  <div id="restoreGrain" class="main-content">
    <div class="centered-box">
    {{#if status}}
      <p>{{status}}... {{progress}}%</p>
    {{else}}
      {{#if error}}
        <p>Restore failed: {{error.status}} {{error.statusText}}</p>
      {{else}}
        <p>Restore failed. Please try again.</p>
      {{/if}}
    {{/if}}
    </div>
  </div>
</template>

<template name="_adminConfigureLoginServiceDialog">
  {{#if visible}}
    <div id="configure-login-service-dialog" class="accounts-dialog accounts-centered-dialog">
      {{> configurationSteps}}

      <p>
        Now, copy over some details.
      </p>
      <p>
        <table>
          <colgroup>
            <col span="1" class="configuration_labels">
            <col span="1" class="configuration_inputs">
          </colgroup>
          {{#each configurationFields}}
            <tr>
              <td>
                <label for="configure-login-service-dialog-{{property}}">{{label}}</label>
              </td>
              <td>
                <input id="configure-login-service-dialog-{{property}}" type="text" value="{{value}}">
              </td>
            </tr>
          {{/each}}
        </table>
      </p>
      <div class="new-section">
        <div class="login-button configure-login-service-dismiss-button">
          Cancel
        </div>
        <a class="accounts-close configure-login-service-dismiss-button">&times;</a>

        <div class="login-button login-button-configure"
             id="configure-login-service-dialog-save-configuration">
          Save Configuration
        </div>
      </div>
    </div>
  {{/if}}
</template>

<template name="admin">
  {{>title "Admin Settings"}}

  {{> _adminConfigureLoginServiceDialog}}
  <div id="admin-settings" class="main-content">
    <div class="centered-box">
      {{#if isUserPermitted}}
        <ul id="settings-tabs" class="nav centered-box">
          <li id="settings-tab" class="{{#if settingsActive}}active{{/if}}">
            {{#linkTo route="admin" data=getToken}}Settings{{/linkTo}}
          </li>
          <li id="users-tab" class="{{#if usersActive}}active{{/if}}">
            {{#linkTo route="adminUsers" data=getToken}}Users{{/linkTo}}
          </li>
          <li id="stats-tab" class="{{#if statsActive}}active{{/if}}">
            {{#linkTo route="adminStats" data=getToken}}Stats{{/linkTo}}
          </li>
          <li id="log-tab" class="{{#if logActive}}active{{/if}}">
            {{#linkTo route="adminLog" data=getToken}}Log{{/linkTo}}
          </li>
          <li id="invites-tab" class="{{#if invitesActive}}active{{/if}}">
            {{#linkTo route="adminInvites" data=getToken}}Send Invite{{/linkTo}}
          </li>
          <li id="caps-tab" class="{{#if capsActive}}active{{/if}}">
            {{#linkTo route="adminCaps" data=getToken}}Capabilities{{/linkTo}}
          </li>
        </ul>
        {{> Template.dynamic template=adminTab}}
        {{#if success}}
        <div class="alert alert-success {{#if fadeAlert}}fade-out{{/if}}"><strong>Success!</strong> {{successMessage}}</div>
        {{/if}}
        {{#if failure}}
        <div class="alert alert-danger {{#if fadeAlert}}fade-out{{/if}}"><strong>Failure!</strong>
          <ul>
            {{#each errors}}
            <li>{{reason}}</li>
            {{/each}}
          </ul>
          For internal server errors, see <code>&lt;install-location&gt;/var/log/sandstorm.log</code> for details.
        </div>
        {{/if}}
      {{else}}
        <p>
          You are not logged in as admin and there isn't a valid token specified. You should
          either log in as an admin user or generate a token from the command line by doing
          `sandstorm admin-token` in order to access the admin settings page.
        </p>
      {{/if}}
    </div>
  </div>
</template>

<template name="adminSettings">
  <form id="admin-settings-form">
    <p><input type="checkbox" class="oauth-checkbox" name="googleLogin"
              value="value" checked={{googleEnabled}} data-servicename="google"> Enable Google Login
       (<a class="configure-oauth" data-servicename="google" href="">configure</a>)
       (<a class="reset-login-tokens" data-servicename="google" href="">log out all users</a>)<br>
       <input type="checkbox" class="oauth-checkbox" name="githubLogin"
              value="value" checked={{githubEnabled}} data-servicename="github"> Enable Github Login
       (<a class="configure-oauth" data-servicename="github" href="">configure</a>)
       (<a class="reset-login-tokens" data-servicename="github" href="">log out all users</a>)<br>
       <input type="checkbox" name="emailTokenLogin" value="value" checked={{emailTokenEnabled}}> Enable Passwordless Email Login<br>
      <span class="details">Choose which services users may use to identify themselves. Anyone can log in, but only users you {{#linkTo route="adminInvites" data=getToken}}invite{{/linkTo}} will be able to install apps or create files.</span></p>
    <p>SMTP Url: <input id="smptUrl" type="text" name="smtpUrl" value="{{smtpUrl}}"><button id="admin-settings-send-toggle">Test</button><br>
      <span class="details">Address of an SMTP relay server, like <code>smtp://user:pass@host:port</code>, which will be used by email apps and to send {{#linkTo route="adminInvites" data=getToken}}email invites{{/linkTo}}. The SMTP server should be configured to allow sending email from your Sandstorm domain and from email addresses that will be used to send invites.</span>
    </p>
    {{#if isEmailTestActive}}
      <p>
        Send test email to: <input id="email-test-to" type="text">
        <p><button id="admin-settings-send-test">Send</button></p>
      </p>
    {{/if}}
    <p>Splash Dialog: <input type="textarea" name="splashDialog" value="{{splashDialog}}"><br>
       Signup Dialog: <input type="textarea" name="signupDialog" value="{{signupDialog}}"><br>
      <span class="details">This will be used as text in the splash page and signup page respectively.</span></p>
    <p>Admin Alert: <input type="textarea" name="adminAlert" value="{{adminAlert}}"><br>
       Alert Time (e.g. "5/9/2022 6:00 PM"): <input id="alertTime" type="text" name="alertTime" value="{{alertTime}}"><br>
       Alert URL (optional): <input id="alertUrl" type="text" name="alertUrl" value="{{alertUrl}}"><br>
      <span class="details">
        This will be shown to all users in the topbar, on the right. If the alert text is
        empty, no alert will be displayed. You can use the following variables that will be replaced
        automatically:
        <ul>
          <li>$TIME : The time component of Alert Time, converted to the user's local time (eg. "1:15:45 PM")</li>
          <li>$DATE : The date component of Alert Time, converted to the user's local time (eg. "6/19/2015")</li>
          <li>$IN_COUNTDOWN : An active countdown until Alert Time (eg. "in 3 days" or "in 1 minute"). Displays "any moment" at the alert time and then disappears after an hour. Useful for announcing scheduled maintenance.</li>
          <li>$ACCOUNT_EXPIRES : The time when the viewer's demo account expires (this is only useful for demo servers)</li>
          <li>$ACCOUNT_EXPIRES_IN : An active countdown until the viewer's demo account is deleted (this is only useful for demo servers)</li>
          <li>$APPNAME : The name of the current app (this variable also works for "Alert URL").</li>
        </ul>
      </span>
    </p>
    <p><button id="admin-settings-save">Save</button></p>
  </form>
</template>

<template name="adminUsers">
  <table class="admin-table">
    <thead>
      <tr>
        <td>Service</td>
        <td>Username</td>
        <td>Name</td>
        <td>User Class</td>
        {{#if quotaEnabled}}
          <td>Quota</td>
          <td>Used</td>
        {{/if}}
        <td>Created</td>
        <td>Last Active</td>
        <td>Invited as</td>
      </tr>
    </thead>
    <tbody>
      {{#each users}}
        <tr>
          <td>{{userService}}</td>
          <td>{{userName}}</td>
          <td>{{profile.name}}</td>
          <td>
            <select class="user-class" name="select">
              <option value="admin" selected={{#if userIsAdmin}}selected{{/if}}>Admin</option>
              <option value="invited" selected={{#if userIsInvited}}selected{{/if}}>Invited User</option>
              <option value="guest" selected={{#if userIsGuest}}selected{{/if}}>Guest</option>
            </select>
          </td>
          {{#if quotaEnabled}}
            <td>{{userQuota}}</td>
            <td>{{userStorageUsage}}</td>
          {{/if}}
          <td title="{{createdAt}}">{{dateString createdAt}}</td>
          <td title="{{lastActive}}">{{dateString lastActive}}</td>
          <td>{{userSignupNote}}</td>
        </tr>
      {{/each}}
    </tbody>
  </table>
</template>

<template name="adminStats">
  <div id="stats">
    <p>Right now: {{current.activeUsers}} users, {{current.activeGrains}} grains</p>
    <p>Today: {{today.activeUsers}} users, {{today.activeGrains}} grains</p>

    <p>Previous days:</p>

    <table>
      <tr>
        <td rowspan="2">date</td>
        <td colspan="3">users</td>
        <td colspan="3">grains</td>
      </tr>
      <tr>
        <td>daily</td>
        <td>weekly</td>
        <td>monthly</td>
        <td>daily</td>
        <td>weekly</td>
        <td>monthly</td>
      </tr>
      {{#each points}}
        <tr>
          <td>{{day}}</td>
          <td>{{daily.activeUsers}}</td>
          <td>{{weekly.activeUsers}}</td>
          <td>{{monthly.activeUsers}}</td>
          <td>{{daily.activeGrains}}</td>
          <td>{{weekly.activeGrains}}</td>
          <td>{{monthly.activeGrains}}</td>
        </tr>
      {{else}}
        <tr>
          <td colspan="7">There are no stats yet, or you are not admin.</td>
        </tr>
      {{/each}}
    </table>
    <h3>API token</h3>
    <button id="regenerateStatsToken">Regenerate Token</button>
    <span><a href="/fetchStats/{{token._id}}">{{token._id}}</a></span>
  </div>
</template>

<template name="adminCaps">
  {{#if powerboxOfferUrl}}
    {{#with powerboxOfferUrl=powerboxOfferUrl}}
      {{>sandstormTopbarItem name="offer" topbar=globalTopbar template="grainPowerboxOffer"
          startOpen=true popupTemplate="grainPowerboxOfferPopup"}}
    {{/with}}
  {{/if}}
  <p><button id="offer-ipnetwork">Offer IpNetwork Capability</button>
     <button id="offer-ipinterface">Offer IpInterface Capability</button><br>
    <span class="details">These buttons create webkeys (special secret addresses) representing permission to directly access the network. IpNetwork represents the capability to make outbound requests to the network. IpInterface represents the capability to receive inbound connections on the machine's main network interface. Some apps -- especially drivers -- will ask for these permissions. To grant them, you'll need to copy/paste the webkey from here into the app's request box. (Eventually, this UI will be superseded by the Powerbox picker.)</span></p>
  <hr>
  <table class="admin-table">
    <thead>
      <tr>
        <td>Type</td>
        <td>User</td>
        <td>Created</td>
      </tr>
    </thead>
    <tbody>
      {{#each caps}}
        <tr class="{{#if disabled}}revoked-cap{{/if}}">
          <td>{{#if frontendRef.ipNetwork}}IpNetwork{{/if}}{{#if frontendRef.ipInterface}}IpInterface{{/if}}</td>
          <td>{{userName}}</td>
          <td title="{{created}}">{{dateString created}}</td>
          <td><a class="disable-cap" data-id="{{_id}}">x</a></td>
        </tr>
      {{/each}}
    </tbody>
  </table>
</template>

<template name="appdemo">
  {{> drydemo}}
</template>

<template name="demo">
  {{> drydemo}}
</template>

<template name="drydemo">
  {{>title pageTitle}}

  <div id="demo" class="main-content">
    <div class="centered-box">
      <h2>Sandstorm Demo</h2>
      {{#if allowDemo}}
        {{#if shouldShowStartDemo}}
          {{#if loggingIn}}
            <p>Logging in...</p>
          {{else}}
            <p><input id="demo-display-name" type="hidden" value="">
               <button id="createDemoUser">{{ createDemoUserLabel }} »</button></p>
          {{/if}}
        {{else}}
          {{#if isDemoUser}}
            <p>You are currently logged in as a one-hour demo user.</p>
            <p><button onclick="browseHome()">Continue the demo</button></p>
          {{else}}
            <p>You are already logged in as a real user.</p>
          {{/if}}
        {{/if}}

        <h3>What is this?</h3>
        <p>Sandstorm is an open source hosting platform for personal instances of web apps. Users
          can upload and install arbitrary software. In addition to improving privacy and control,
          <a href="https://blog.sandstorm.io/news/2014-07-21-open-source-web-apps-require-federated-hosting.html">
          this is the only way to make Open Source web apps viable.</a></p>
        <p>Notes:</p>
        <ul>
          <li>Demo accounts last one hour.</li>
          <li>Demo accounts can only install approved apps, but this
            is an artificial limitation. Real users can upload
            whatever code they want, as each app server runs in a
            secure sandbox.</li>
          <li>We only have one machine. It may get slow or crashy under excessive load.</li>
          <li>We know the UI design needs work. This is a tech demo. ;)</li>
          <li><a href="https://sandstorm.io">Read more at Sandstorm.io.</a></li>
        </ul>
      {{else}}
        <p>Sorry, this server does not allow demo accounts.</p>
      {{/if}}
    </div>
  </div>
</template>

<template name="devAccounts">
  {{>title pageTitle}}

  <div id="demo" class="main-content">
    <div class="centered-box">
      <h2>Developer Accounts</h2>
        {{#if shouldShowStartDevAccounts}}
          {{#if loggingIn}}
            <p>Logging in...</p>
          {{else}}
            <button id="loginAliceDevAccount" class="devLogin">Log in as Alice (admin) »</button>
            <button id="loginBobDevAccount" class="devLogin">Log in as Bob »</button>
            <button id="loginCarolDevAccount" class="devLogin">Log in as Carol »</button>
            <button id="loginDaveDevAccount" class="devLogin">Log in as Dave »</button>
            <button id="loginEveDevAccount" class="devLogin">Log in as Eve »</button>
          {{/if}}
        {{else}}
            <p>You are already logged in.</p>
            <p><button onclick="browseHome()">See your apps »</button></p>
        {{/if}}

        <h3>What is this?</h3>
        <p>This page is only for developer Sandstorm instances (ie. the ALLOW_DEV_ACCOUNTS setting
        is enabled in your sandstorm.conf).</p>
    </div>
  </div>
</template>

<template name="about">
  {{>title "About Sandstorm"}}

  <div id="about" class="main-content">
    <div class="centered-box">
      <h2>Sandstorm Server</h2>
      <p class="heading-subtext"><a href="https://sandstorm.io">https://sandstorm.io</a></p>
      <p>Build {{build}}</p>
      {{#if isUnofficial}}
      <p><b>WARNING:</b> This server is running an unofficial build of Sandstorm which may contain
        modifications not reviewed by the developers.</p>
      {{/if}}
      <button id="show-changelog">Show Changelog</button>
      {{#if showChangelog}}
        {{> changelog}}
      {{/if}}
      <p><a href="https://sandstorm.io">Sandstorm.io</a> is an open source hosting platform for
        personal/private instances of web apps. Users can upload and install arbitrary software
        through a simple app-store-like web interface. In addition to better privacy,
        <a href="https://blog.sandstorm.io/news/2014-07-21-open-source-web-apps-require-federated-hosting.html">
        this is the only way to make Open Source web apps viable.</a></p>
      <h3>Core Developers</h3>
      <ul class="dev-list">
        <li><a href="https://github.com/kentonv">
            <img src="/logos/kenton.jpg" alt="Kenton Varda"><br>
            Kenton<br>Varda</a></li>
        <li><a href="https://github.com/jadeqwang">
            <img src="/logos/jade.jpg" alt="Jade Wang"><br>
            Jade<br>Wang</a></li>
        <li><a href="https://github.com/jparyani">
            <img src="/logos/jparyani.jpg" alt="Jason Paryani"><br>
            Jason<br>Paryani</a></li>
        <li><a href="https://github.com/dwrensha">
            <img src="/logos/drenshaw.jpg" alt="David Renshaw"><br>
            David<br>Renshaw</a></li>
        <li><a href="https://github.com/paulproteus">
            <img src="/logos/asheesh.jpg" alt="Asheesh Laroia"><br>
            Asheesh<br>Laroia</a></li>
        <li><a href="http://nenanguyen.ca">
            <img src="/logos/nena.jpg" alt="Néna Nguyễn"><br>
            Néna<br>Nguyễn</a></li>
        <li><a href="https://github.com/zarvox">
            <img src="/logos/drew.jpg" alt="Drew Fisher"><br>
            Drew<br>Fisher</a></li>
        <li><a href="https://plus.google.com/u/0/114357619139436426265">
            <img src="/logos/garply.jpg" alt="Garply"><br>
            Garply<br>&nbsp;</a></li>
      </ul>
      <h3>Advisors</h3>
      <ul class="advisor-list">
        <li><a href="https://github.com/swetland">
            <img src="/logos/swetland.jpg" alt="Brian Swetland"><br>
            Brian<br>Swetland</a></li>
        <li><a href="https://github.com/amluto">
            <img src="/logos/luto.jpg" alt="Andrew Lutomirski"><br>
            Andrew<br>Lutomirski</a></li>
        <li><a href="https://github.com/jasvir">
            <img src="/logos/jasvir.jpg" alt="Jasvir Nagra"><br>
            Jasvir<br>Nagra</a></li>
        <li><a href="https://github.com/mseaborn">
            <img src="/logos/smiley.png" alt="Mark Seaborn"><br>
            Mark<br>Seaborn</a></li>
        <li><a href="http://en.wikipedia.org/wiki/Mark_S._Miller">
            <img src="/logos/markm.jpg" alt="Mark Miller"><br>
            Mark<br>Miller</a></li>
      </ul>
      <h3>Key Individual Sponsors</h3>
      <p class="heading-subtext">from <a href="http://igg.me/at/sandstorm">our Indiegogo campaign</a></p>
      <ul class="backer-list">
        <li><a href="http://rogerwagner.com/">
            <img src="/logos/wagner.jpg"><br>
            Roger Wagner</a></li>
        <li><a href="https://github.com/audreyt">
            <img src="/logos/audreyt.jpg"><br>
            Audrey Tang</a></li>
      </ul>
      <h3>Corporate Sponsors</h3>
      <p class="heading-subtext">from <a href="http://igg.me/at/sandstorm">our Indiegogo campaign</a></p>
      <div class="corptags">
        <div class="corptag">
          <a href="http://draw.io"><img src="/logos/draw.io-logo.svg"></a>
        </div>
        <div class="corptag">
          <img src="/logos/humanweb.png" style="padding-top: 68px">
        </div>
        <div class="corptag">
          <a href="https://uniregistry.com"><img src="/logos/uniregistry.svg"></a>
        </div>
      </div>
      <h3>Backers</h3>
      <p class="heading-subtext">from <a href="http://igg.me/at/sandstorm">our Indiegogo campaign</a></p>
      {{#if backers}}
      <ul class="backer-list">
        {{#each backers}}
          <li>{{.}}</li>
        {{/each}}
        <li>{{anonCount}} anonymous contributors</li>
      </ul>
      {{else}}
      <p>loading...</p>
      {{/if}}
      <h3>Third-party works used</h3>
      <ul>
        <li><a href="http://nodejs.org/">Node.js</a> (MIT license)</li>
        <li><a href="https://www.meteor.com/">Meteor web framework</a> (MIT license)</li>
        <li><a href="https://github.com/EventedMind/iron-router">Iron Router routing library</a> (MIT license)</li>
        <li><a href="http://underscorejs.org/">Underscore.js</a> (MIT license)</li>
        <li><a href="http://www.senchalabs.org/connect/">Connect middleware</a> (MIT license)</li>
        <li><a href="https://github.com/andris9/simplesmtp">Simple SMTP by Andris Reinman</a> (MIT license)</li>
        <li><a href="https://github.com/justmoon/node-bignum">node-bignum by Stefan Thomas</a> (MIT license)</li>
        <li><a href="https://github.com/jedisct1/libsodium">libsodium</a> (MIT license)</li>
        <li><a href="https://www.npmjs.org/package/es6-promises">ES6 Promises polyfill by Dmitry Korobkin</a> (MIT license)</li>
        <li><a href="https://www.google.com/fonts/specimen/Open+Sans">Open Sans font by Google</a> (Apache 2.0 license)</li>
        <li><a href="http://www.thenounproject.com/naomiatkinson/uploads/">Icons by Naomi Atkinson from The Noun Project</a> (CC BY 3.0 license)</li>
        <li><a href="https://github.com/drudru/ansi_up">ansi_up library by Dru Nelson</a> (MIT license)</li>
        <li><a href="https://github.com/joyent/http-parser">Node/nginx HTTP parser library maintained by Joyent</a> (MIT license)</li>
        <li><a href="http://libb64.sourceforge.net/">libb64 by Chris Venter</a> (Public Domain)</li>
        <li><a href="http://tukaani.org/xz/">XZ Utils</a> (Public Domain / GPL)</li>
        <li><a href="http://www.gnu.org/software/libc/libc.html">GNU C library</a> and
            <a href="https://gcc.gnu.org/libstdc++/">C++ Library</a> (LGPL license)</li>
      </ul>
      <p>These works are copyright the respective authors and used under the terms of the respective
        licenses.</p>
      <h3>Copyright</h3>
      <p>The Sandstorm implementation is copyright by Sandstorm Development Group, Inc. and
         contributors. The implementation is licensed under the Apache License 2.0.</p>
      <p>"Sandstorm" and the Sandstorm logo are trademarks of Sandstorm Development Group, Inc.,
         and may not be used to advertise derivative works nor commercial services without
         written consent from Sandstorm Development Group, Inc.</p>
      <p><a href="https://github.com/sandstorm-io/sandstorm/blob/master/LICENSE">Full license details.</a></p>
    </div>
  </div>
</template>
